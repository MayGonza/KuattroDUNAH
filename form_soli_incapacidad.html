<!DOCTYPE html>
<html lang="es">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Formulario de Solicitud de Incapacidad</title>
    <link rel="stylesheet" href="public/css/styles_fsi.css">
</head>

<body>

    <!-- Encabezado con logo -->
    <header class="navbar">
        <div class="navbar-container">
            <button class="menu-toggle" onclick="toggleMenu()">‚ò∞</button>
            <a href="inicioempleados.html" class="nav-logo">
                <img src="https://kuattro.hn/wp-content/uploads/2019/03/Logo_Kuattro_VFinal_Flat-1.png" alt="Logo"
                    class="nav-logo-img">
            </a>
            <div class="user-menu">
                <button class="user-button" onclick="toggleUserMenu()">üë§</button>
                <div class="user-dropdown" id="userDropdown">
                    <a href="perfil_recurso.html">Perfil</a>
                    <a href="cambiarcontrase√±a.html">Cambiar contrase√±a</a>
                    <a href="login.html">Cerrar Sesi√≥n</a>
                </div>
            </div>
        </div>
    </header>

    <!-- Men√∫ lateral -->
    <aside class="side-menu" id="sideMenu">
        <nav>
            <ul>
                <li><a href="solicitudes.html">Solicitudes</a></li>
                <li><a href="Usuarios.html">Usuarios</a></li>
                <li><a href="empleado.html">Empleado</a></li>
                <li class="has-submenu">
                    <a href="#" onclick="toggleSubMenu(event)">
                        Seguridad
                        <span class="arrow">‚ñº</span>
                    </a>
                    <ul class="submenu">
                        <li><a href="parametros.html">Par√°metros</a></li>
                        <li><a href="usuarioyseguridad.html">Roles y Permisos</a></li>
                    </ul>
                </li>
                <li class="has-submenu">
                    <a href="#" onclick="toggleSubMenu(event)">
                        Mantenimiento
                        <span class="arrow">‚ñº</span>
                    </a>
                    <ul class="submenu">
                        <li><a href="backup.html">Respaldo y Restauraci√≥n</a></li>
                        <li><a href="bitacora.html">Bit√°cora</a></li>
                    </ul>
                <li><a href="nosotros.html">Nosotros</a></li>
                <li><a href="contacto.html">Contacto</a></li>
                </li>
            </ul>
        </nav>
    </aside>

    <!-- Todo lo que vayan a agregar -->
    <main class="main-content" id="mainContent">
        <!-- Contenedor principal -->
        <div class="form-container">

            <!-- Cabecera -->
            <header class="header">
                <div class="logo">
                    <img src="https://kuattro.hn/wp-content/uploads/2019/03/Logo_Kuattro_VFinal_Flat-1.png"
                        alt="Logo_Kuattro" />
                </div>
            </header>
            <div class="titulo">
                <h1>SOLICITUD DE INCAPACIDAD</h1>
            </div>
            <hr>
            <div class="fecha">
                <p>Fecha: <span id="fechaActual"></span></p>
            </div>

            <!-- Formulario de solicitud de vacaciones -->
            <form id="vacacionesForm">

                <!-- Contenedor de datos personales -->
                <div class="grupo borde">
                    <label for="nombre">Dirigido a: <b>Departamento de Recursos Humanos</b></label>
                    <div class="campo">
                        <label for="nombre">Nombre del colaborador:</label>
                        <input type="text" id="nombre" name="nombre" readonly>
                    </div>
                    <div class="campo1">
                        <label for="codigo">C√≥digo:</label>
                        <input type="text" id="codigo" name="codigo" readonly>

                        <label for="posicion">Posici√≥n:</label>
                        <input type="text" id="posicion" name="posicion" readonly>

                        <label for="sede">Sede:</label>
                        <input type="text" id="sede" name="sede" readonly>
                    </div>
                </div>

                <!-- Contenedor de solicitud de vacaciones -->
                <div class="grupo borde">
                    <div class="campo2">
                        <label for="dias">Por este medio solicito</label>
                        <input type="number" id="diasSolicitados" name="diasSolicitados" step="0.5" min="0.5" required>
                        <label for="dias">d√≠as de incapacidad, en las siguientes fechas:</label>
                    </div>
                    <div class="campos">
                        <label for="fechaInicio">Iniciando el</label>
                        <input type="date" id="fechaInicio" name="fechaInicio" required>
                    </div>
                    <div class="campos">
                        <label for="fechaFin">hasta el d√≠a</label>
                        <input type="date" id="fechaFin" name="fechaFin" required>
                        <label for="fechaRegreso">regresando a mis labores</label>
                    </div>
                    <div class="campos">
                        <label for="fechaRegreso">cotidianas el</label>
                        <input type="date" id="fechaRegreso" name="fechaRegreso" required>
                    </div>
                </div>

                <div class="grupo borde">

                    <!-- Observaciones -->
                    <label for="observaciones">Observaciones:</label>
                    <div class="campo">
                        <textarea id="observaciones" name="observaciones" rows="5"
                            placeholder="Escriba aqu√≠ sus observaciones..."></textarea>
                    </div>

                    <!-- Apartado para subir im√°genes -->
                    <div>
                        <!-- Bot√≥n para abrir el modal de selecci√≥n de imagen -->
                        <button id="abrirModal" class="btnAbrirModal">Subir Imagen</button>
                    </div>

                    <!-- El Modal -->
                    <div id="miModal" class="modal">
                        <div class="modal-contenido">
                            <span class="cerrar" id="cerrarModal">&times;</span>
                            <!-- Input file dentro del modal -->
                            <label for="fileInput" class="seleImagen">Seleccionar Imagen</label>
                            <input type="file" id="fileInput" class="inputImagen" accept="image/*">

                            <!-- Vista previa de la imagen seleccionada -->
                            <div id="preview">No se ha seleccionado ninguna imagen.</div>

                            <!-- Contenedor de los botones centrados -->
                            <div class="modal-botones">
                                <!-- Botones de acci√≥n -->
                                <button id="saveButton" class="btnModalGuardar" style="display:none;">Aceptar</button>
                                <button id="resetButton" class="btnModalCancelar"
                                    style="display:none;">Cancelar</button>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Bot√≥n de env√≠o -->
                <div class="botones">
                    <button type="submit" class="submitBtn">Enviar</button>
                    <button type="reset" class="cancelBtn"
                        onclick="window.location.href='solicitudes.html'">Cancelar</button>
                </div>
            </form>
        </div>
    </main>

    <script>
        // Mostrar la fecha actual
        document.getElementById("fechaActual").textContent = new Date().toLocaleDateString("es-ES");

        function toggleMenu() {
            const sideMenu = document.getElementById('sideMenu');
            const mainContent = document.getElementById('mainContent');
            sideMenu.classList.toggle('open');
            mainContent.classList.toggle('shifted');
        }

        function toggleUserMenu() {
            const userDropdown = document.getElementById('userDropdown');
            userDropdown.classList.toggle('show');
        }

        window.onclick = function (event) {
            if (!event.target.matches('.user-button')) {
                const dropdowns = document.getElementsByClassName('user-dropdown');
                for (let i = 0; i < dropdowns.length; i++) {
                    const openDropdown = dropdowns[i];
                    if (openDropdown.classList.contains('show')) {
                        openDropdown.classList.remove('show');
                    }
                }
            }
        }

        window.onbeforeunload = function () {
            // Establece la posici√≥n de desplazamiento antes de que la p√°gina se recargue
            window.scrollTo(0, 0); // Esto asegura que la p√°gina siempre comience desde la parte superior al recargarse
        };

        // Ajustar tama√±o del input
        function adjustInputWidth(input) {
            // Crear un span temporal para medir el ancho
            const tempSpan = document.createElement("span");
            tempSpan.style.visibility = "hidden";
            tempSpan.style.position = "absolute";
            tempSpan.style.whiteSpace = "pre";
            tempSpan.style.font = window.getComputedStyle(input).font;
            tempSpan.textContent = input.value;

            document.body.appendChild(tempSpan);

            // Ajustar el tama√±o del input seg√∫n el ancho del span
            input.style.width = `${tempSpan.offsetWidth + 25}px`;  // A√±adir un peque√±o margen

            document.body.removeChild(tempSpan);  // Eliminar el span temporal
        }


        // Obtener los elementos del DOM
        const abrirModal = document.getElementById('abrirModal');
        const miModal = document.getElementById('miModal');
        const cerrarModal = document.getElementById('cerrarModal');
        const fileInput = document.getElementById('fileInput');
        const preview = document.getElementById('preview');
        const resetButton = document.getElementById('resetButton');
        const saveButton = document.getElementById('saveButton');

        // Mostrar el modal cuando el usuario haga clic en el bot√≥n "Seleccionar Imagen"
        abrirModal.addEventListener('click', function (event) {
            event.preventDefault(); // Previene el env√≠o del formulario
            miModal.style.display = 'flex'; // Cambiar la propiedad para mostrar el modal
        });

        // Cerrar el modal cuando el usuario haga clic en la "X"
        cerrarModal.addEventListener('click', function () {
            miModal.style.display = 'none';
        });

        saveButton.addEventListener('click', function (event) {
            event.preventDefault();
            miModal.style.display = 'none';
        });

        // A√±adir un event listener para el bot√≥n de reset
        resetButton.addEventListener('click', function (event) {
            event.preventDefault();
            // Limpiar el archivo seleccionado
            fileInput.value = '';  // Esto "desselecciona" el archivo

            // Limpiar el contenido de la vista previa
            preview.innerHTML = 'No se ha seleccionado ninguna imagen.';

            // Ocultar el bot√≥n de cancelaci√≥n
            saveButton.style.display = 'none';
            resetButton.style.display = 'none';
        });

        // Cerrar el modal si el usuario hace clic fuera del contenido del modal
        window.addEventListener('click', function (event) {
            if (event.target === miModal) {
                miModal.style.display = 'none';
            }
        });

        // A√±adir un event listener para cuando el usuario seleccione una imagen
        fileInput.addEventListener('change', function (event) {
            const file = event.target.files[0];

            // Verificamos si se ha seleccionado un archivo
            if (file) {
                // Crear una URL temporal para mostrar la imagen
                const reader = new FileReader();
                reader.onload = function (e) {
                    // Crear un elemento de imagen para mostrar la imagen seleccionada
                    const img = document.createElement('img');
                    img.src = e.target.result;
                    preview.innerHTML = ''; // Limpiar cualquier contenido previo
                    preview.appendChild(img); // A√±adir la imagen al contenedor
                };
                reader.readAsDataURL(file); // Leer la imagen como una URL

                // Mostrar el bot√≥n para cancelar la selecci√≥n
                saveButton.style.display = 'block';
                resetButton.style.display = 'block';
            } else {
                preview.innerHTML = 'No se ha seleccionado ninguna imagen.';
                resetButton.style.display = 'none';
            }
        });

        const fechaHoy = new Date().toLocaleDateString('en-CA');
        document.getElementById("fechaInicio").setAttribute("min", fechaHoy);

        function calcularFechaFin() {
            const fechaInicio = new Date(document.getElementById("fechaInicio").value);
            let diasSolicitados = parseFloat(document.getElementById("diasSolicitados").value);

            // Validaci√≥n
            if (isNaN(fechaInicio) || !fechaInicio.getTime() || isNaN(diasSolicitados) || diasSolicitados <= 0) {
                return; // Salir si la fecha o los d√≠as solicitados no son v√°lidos
            }

            let fechaFin = new Date(fechaInicio);
            let diasRestantes = diasSolicitados;

            while (diasRestantes > 0) {

                if (diasRestantes > 0) {
                    fechaFin.setDate(fechaFin.getDate() + 1); // Avanzar al siguiente d√≠a
                }

                if (fechaFin.getDay() === 6) {  // S√°bado
                    diasRestantes -= 0.5;  // Restar 0.5 d√≠as por s√°bado
                } else if (fechaFin.getDay() === 0) {  // Domingo
                    // No restar d√≠as si es domingo
                } else {  // Lunes a viernes
                    diasRestantes -= 1;
                }
            }

            // Establecer la fecha de fin calculada
            document.getElementById("fechaFin").setAttribute("min", fechaFin.toLocaleDateString('en-CA'));

            // Calcular la fecha de regreso (un d√≠a despu√©s de la fecha de fin)
            fechaFin.setDate(fechaFin.getDate() + 1);
            document.getElementById("fechaRegreso").setAttribute("min", fechaFin.toLocaleDateString('en-CA'));
        }

        // Event listener para cuando se cambie la fecha de inicio o los d√≠as solicitados
        document.getElementById("fechaInicio").addEventListener("change", calcularFechaFin);
        document.getElementById("diasSolicitados").addEventListener("input", calcularFechaFin);



        // Validacion con el BACKEND
        const diasSolicitadosInput = document.getElementById("diasSolicitados");
        const formulario = document.getElementById("vacacionesForm");

        diasSolicitadosInput.addEventListener('keypress', function (e) {
            const valor = this.value;
            const tecla = e.key;

            // Permitir n√∫meros (0-9) y el punto (.)
            if (/[^0-9.]/.test(tecla)) {
                e.preventDefault();  // Bloquear cualquier tecla que no sea un n√∫mero o punto
            }

            // Permitir solo un punto
            if (tecla === '.' && valor.includes('.')) {
                e.preventDefault();  // Si ya hay un punto, evitar que se ingrese otro
            }
        });

        let idUsuario = null;
        fetch(`http://localhost:3000/datos_empleado_solicitud`)
            .then((response) => response.json())
            .then((data) => {
                if (data) {
                    const { id_usuario, primer_nombre, segundo_nombre, primer_apellido, segundo_apellido, cod_empleado, nombre_cargo, nombre_sucursal } = data;
                    document.getElementById("nombre").value = `${primer_nombre} ${segundo_nombre || ''} ${primer_apellido} ${segundo_apellido || ''}`;
                    document.getElementById("codigo").value = cod_empleado;
                    document.getElementById("posicion").value = nombre_cargo;
                    document.getElementById("sede").value = nombre_sucursal;

                    // Ajustar el tama√±o de los inputs
                    adjustInputWidth(document.getElementById("codigo"));
                    adjustInputWidth(document.getElementById("posicion"));
                    adjustInputWidth(document.getElementById("sede"));

                    idUsuario = id_usuario;
                } else {
                    console.log('Ocurrio un error');
                }
            })
            .catch((error) => console.error(error));


        formulario.addEventListener('submit', function (event) {

            // Si todo es v√°lido, procedemos a enviar la informaci√≥n
            event.preventDefault(); // Prevenimos el env√≠o est√°ndar del formulario
            const formData = new FormData(this);

            formData.append("fecha_solicitud", new Date().toLocaleDateString('en-CA'));
            formData.append("fecha_inicio_solicitud", document.getElementById("fechaInicio").value);
            formData.append("fecha_final_solicitud", document.getElementById("fechaFin").value);
            formData.append("fecha_regreso", document.getElementById("fechaRegreso").value);
            formData.append("dias_solicitados", document.getElementById("diasSolicitados").value);
            formData.append("observaciones_solicitud", document.getElementById("observaciones").value);
            formData.append("imagen", fileInput.files[0]);
            formData.append("id_usuario", idUsuario);
            formData.append("id_estado", 3);
            formData.append("id_tipo_solicitud", 2);

            fetch('http://localhost:3000/crear_solicitud', {
                method: 'POST',
                body: formData // Aqu√≠ es donde se env√≠a la imagen y los dem√°s campos
            })
                .then(response => response.json())
                .then(data => {
                    console.log('Solicitud creada:', data);

                    // Crear el contenedor del mensaje de √©xito flotante
                    const successMessage = document.createElement("div");
                    successMessage.classList.add("toast-message");

                    // Crear la imagen del √≠cono de check
                    const checkIcon = document.createElement("img");
                    checkIcon.src = "public/imagenes/check.png"; // Aseg√∫rate de poner la ruta correcta de la imagen
                    checkIcon.alt = "Check icon"; // Descripci√≥n alternativa para accesibilidad

                    // Agregar la imagen antes del texto del mensaje
                    successMessage.appendChild(checkIcon);

                    // Agregar el texto del mensaje
                    successMessage.appendChild(document.createTextNode("¬°Solicitud enviada exitosamente!"));

                    // Agregar la clase "toast-message" para estilizarlo
                    document.body.appendChild(successMessage);

                    // Desaparecer el mensaje
                    setTimeout(function () {
                        successMessage.style.opacity = "0";  // Desvanecer el mensaje
                        setTimeout(function () {
                            successMessage.remove();  // Eliminar el mensaje del DOM
                        }, 500);  // Esperar el tiempo de la transici√≥n antes de eliminar

                        // Redirigir a otra p√°gina despu√©s de que el mensaje desaparezca
                        window.location.href = "solicitudes.html"; // Redirigir a la p√°gina de login
                    }, 2500);  // El mensaje desaparecer√° despu√©s de 2.5 segundos
                })
                .catch((error) => console.error('Error:', error));
        });

    </script>


    <!-- Pie de p√°gina com√∫n -->
    <footer class="footer">
        <p>&copy; Kuattro Distribuciones. Todos los derechos reservados.</p>
    </footer>
</body>

</html>